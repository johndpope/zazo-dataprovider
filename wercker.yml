box: zazo/rails

build:
  services:
    - id: postgres
      tag: 9.4
      env:
        POSTGRES_USER: events_db
        POSTGRES_PASSWORD: secret888zazo
        POSTGRES_DB: events_db
    - id: mysql
      tag: 5.7
      env:
        MYSQL_USER: users_db
        MYSQL_PASSWORD: secret888zazo
        MYSQL_DATABASE: users_db
        MYSQL_ROOT_PASSWORD: secret888zazo
  steps:
    - script:
        name: show environment variables
        code: env
    - script:
        name: update rubygems
        code: gem update --system '2.4.8'
    - asux/bundle-install@1.1.8:
        gemfile: config/Gemfile
        path: /usr/local/bundle
        without: development production
    - script:
        name: db schema load
        code: RAILS_ENV=test rake db:multiple:schema:load
    - script:
        name: create rspec and coverage dir
        code: mkdir -p $WERCKER_REPORT_ARTIFACTS_DIR/rspec $WERCKER_REPORT_ARTIFACTS_DIR/coverage
    - script:
        name: rspec
        code: rspec
  after-steps:
    - asux/pretty-slack-notify:
        webhook_url: $slack_url
        channel: devops

deploy:
  steps:
    - asux/elastic-beanstalk-deploy:
        key: $AWS_ACCESS_KEY_ID
        secret: $AWS_SECRET_ACCESS_KEY
        app_name: $EB_APP
        env_name: $EB_ENV
        region: $AWS_REGION
  after-steps:
    - wantedly/pretty-slack-notify:
        webhook_url: $slack_url
